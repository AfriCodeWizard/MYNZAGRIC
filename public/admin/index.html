<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
  <script>
    // Minimal logging to verify OAuth flow with auth_endpoint
    console.log('=== Decap CMS Loading ===');
    console.log('Current URL:', window.location.href);
    console.log('Hash:', window.location.hash);
    
    // Check for token in various places on page load
    let tokenToUse = null;
    let providerToUse = 'github';
    
    // Check 1: URL hash
    if (window.location.hash.includes('access_token')) {
      try {
        const hashParams = new URLSearchParams(window.location.hash.substring(2));
        tokenToUse = hashParams.get('access_token');
        providerToUse = hashParams.get('provider') || 'github';
        console.log('→ Token found in URL hash');
      } catch(e) {}
    }
    
    // Check 2: window.netlifyAuth (from popup)
    if (!tokenToUse && window.netlifyAuth && window.netlifyAuth.token) {
      tokenToUse = window.netlifyAuth.token;
      providerToUse = window.netlifyAuth.provider || 'github';
      console.log('→ Token found in window.netlifyAuth');
    }
    
    // Check 3: window.decapAuthToken (from popup)
    if (!tokenToUse && window.decapAuthToken) {
      tokenToUse = window.decapAuthToken;
      providerToUse = window.decapAuthProvider || 'github';
      console.log('→ Token found in window.decapAuthToken');
    }
    
    // Check 4: sessionStorage
    if (!tokenToUse) {
      const storedToken = sessionStorage.getItem('decap_oauth_token');
      const storedProvider = sessionStorage.getItem('decap_oauth_provider');
      if (storedToken) {
        tokenToUse = storedToken;
        providerToUse = storedProvider || 'github';
        console.log('→ Token found in sessionStorage');
      }
    }
    
    // If we found a token and it's not in hash, set it
    if (tokenToUse && !window.location.hash.includes('access_token')) {
      console.log('→ Setting token in hash...');
      window.location.hash = '#/access_token=' + encodeURIComponent(tokenToUse) + '&token_type=bearer';
      // Clear stored token
      sessionStorage.removeItem('decap_oauth_token');
      sessionStorage.removeItem('decap_oauth_provider');
    }
    
    // Listen for token from OAuth popup (when using auth_endpoint)
    window.addEventListener('message', function(event) {
      // Only accept messages from same origin
      if (event.origin !== window.location.origin) {
        return;
      }
      
      console.log('=== Message received from popup ===');
      console.log('Data:', event.data);
      
      // Check for token in message (from OAuth callback popup)
      if (event.data && (event.data.token || event.data.type === 'authorization')) {
        const token = event.data.token;
        const provider = event.data.provider || 'github';
        
        console.log('✓ Token received from OAuth popup!');
        console.log('Token length:', token ? token.length : 'missing');
        console.log('Provider:', provider);
        
        // Manually authenticate Decap CMS with the token
        if (token && window.CMS) {
          console.log('→ Attempting to authenticate Decap CMS with received token...');
          try {
            // Try to get the backend and authenticate
            const backend = window.CMS.getBackend();
            if (backend && backend.authenticate) {
              console.log('→ Calling backend.authenticate()...');
              backend.authenticate({
                token: token,
                provider: provider
              }).then(function() {
                console.log('✓ Authentication successful!');
                // Reload to show dashboard
                window.location.reload();
              }).catch(function(error) {
                console.error('✗ Authentication failed:', error);
                // Try alternative method - set token in backend state
                if (backend.tokenPromise) {
                  backend.tokenPromise = Promise.resolve(token);
                  console.log('→ Set tokenPromise, reloading...');
                  window.location.reload();
                }
              });
            } else {
              console.log('→ Backend.authenticate not available, trying alternative...');
              // Alternative: Set token directly in backend
              if (backend && backend.implementation) {
                backend.implementation.token = token;
                console.log('→ Set token in backend implementation, reloading...');
                window.location.reload();
              } else {
                // Last resort: Set token in URL hash and reload
                console.log('→ Setting token in URL hash and reloading...');
                window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
                setTimeout(function() {
                  window.location.reload();
                }, 100);
              }
            }
          } catch(e) {
            console.error('✗ Error authenticating:', e);
            // Fallback: Set token in hash and reload
            console.log('→ Fallback: Setting token in hash and reloading...');
            window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
            setTimeout(function() {
              window.location.reload();
            }, 100);
          }
        } else if (token) {
          // Decap CMS not loaded yet, store token and set in hash
          console.log('→ Decap CMS not loaded yet, storing token and setting in hash...');
          sessionStorage.setItem('decap_oauth_token', token);
          sessionStorage.setItem('decap_oauth_provider', provider);
          // Set token in hash immediately - Decap CMS will read it on load
          window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
          console.log('✓ Token set in hash, Decap CMS should read it on initialization');
        }
      }
    });
    
    // Monitor when Decap CMS loads and check for token in hash
    window.addEventListener('load', function() {
      // Check if token is in hash
      const hash = window.location.hash;
      if (hash.includes('access_token')) {
        console.log('✓ Token found in URL hash on page load');
        console.log('Hash:', hash);
        
        // Extract token from hash
        try {
          const hashParams = new URLSearchParams(hash.substring(2)); // Remove #/
          const token = hashParams.get('access_token');
          const tokenType = hashParams.get('token_type');
          
          if (token) {
            console.log('→ Extracted token from hash, length:', token.length);
            console.log('→ Waiting for Decap CMS to initialize...');
            
            // Wait for Decap CMS to fully initialize and try different access methods
            let checkInterval = setInterval(function() {
              if (window.CMS) {
                try {
                  // Try multiple ways to access the backend
                  let backend = null;
                  
                  // Method 1: window.CMS.getBackend() - wait for it to be ready
                  try {
                    if (window.CMS.getBackend) {
                      backend = window.CMS.getBackend();
                      if (!backend) {
                        // Backend might not be initialized yet, try waiting
                        console.log('→ getBackend() returned null/undefined - backend may not be initialized yet');
                      }
                    }
                  } catch(e) {
                    console.log('→ getBackend() error:', e.message);
                  }
                  
                  // Method 2: Try to get backend from registry
                  if (!backend && window.CMS.getRegistry) {
                    try {
                      const registry = window.CMS.getRegistry();
                      if (registry && registry.getBackend) {
                        backend = registry.getBackend();
                      }
                      // Also try registry.get('backend')
                      if (!backend && registry.get) {
                        backend = registry.get('backend');
                      }
                    } catch(e) {
                      console.log('→ Registry access error:', e.message);
                    }
                  }
                  
                  // Method 3: Access through CMS instance properties
                  if (!backend) {
                    try {
                      if (window.CMS.backend) {
                        backend = window.CMS.backend;
                      }
                    } catch(e) {}
                  }
                  
                  // Method 4: Try to access through window.netlifyCMS (alternative name)
                  if (!backend && window.netlifyCMS) {
                    try {
                      if (window.netlifyCMS.getBackend) {
                        backend = window.netlifyCMS.getBackend();
                      }
                    } catch(e) {}
                  }
                  
                  if (backend) {
                    console.log('✓ Decap CMS backend found');
                    clearInterval(checkInterval);
                    
                    // Try to manually authenticate
                    console.log('→ Attempting to authenticate with token from hash...');
                    console.log('→ Backend type:', typeof backend);
                    console.log('→ Backend keys:', backend ? Object.keys(backend) : 'none');
                    
                    // Try different authentication methods
                    let authAttempted = false;
                    
                    // Method 1: backend.authenticate()
                    if (backend.authenticate && typeof backend.authenticate === 'function') {
                      console.log('→ Trying backend.authenticate()...');
                      authAttempted = true;
                      backend.authenticate({
                        token: token,
                        token_type: tokenType || 'bearer',
                        provider: 'github'
                      }).then(function() {
                        console.log('✓ Authentication successful via backend.authenticate()');
                        setTimeout(function() {
                          window.location.reload();
                        }, 500);
                      }).catch(function(err) {
                        console.log('✗ backend.authenticate() failed:', err);
                        tryAlternativeAuth();
                      });
                    } else {
                      tryAlternativeAuth();
                    }
                    
                    function tryAlternativeAuth() {
                      // Method 2: backend.implementation
                      if (backend.implementation) {
                        console.log('→ Trying backend.implementation...');
                        if (backend.implementation.authenticate) {
                          backend.implementation.authenticate({
                            token: token,
                            token_type: tokenType || 'bearer'
                          }).then(function() {
                            console.log('✓ Authentication successful via backend.implementation.authenticate()');
                            setTimeout(function() {
                              window.location.reload();
                            }, 500);
                          }).catch(function(err) {
                            console.log('✗ backend.implementation.authenticate() failed:', err);
                            trySetToken();
                          });
                        } else {
                          trySetToken();
                        }
                      } else {
                        trySetToken();
                      }
                    }
                    
                    function trySetToken() {
                      // Method 3: Set token directly
                      console.log('→ Trying to set token directly in backend...');
                      try {
                        if (backend.tokenPromise) {
                          backend.tokenPromise = Promise.resolve(token);
                        }
                        if (backend.implementation) {
                          backend.implementation.token = token;
                        }
                        if (backend.token) {
                          backend.token = token;
                        }
                        console.log('→ Token set, reloading...');
                        setTimeout(function() {
                          window.location.reload();
                        }, 500);
                      } catch(e) {
                        console.log('✗ Could not set token directly:', e);
                        // Last resort: trigger hashchange
                        console.log('→ Last resort: Triggering hashchange event...');
                        window.dispatchEvent(new HashChangeEvent('hashchange', {
                          oldURL: window.location.href,
                          newURL: window.location.href
                        }));
                      }
                    }
                  } else {
                    // Backend not found - try to manually trigger authentication with token in hash
                    console.log('→ Backend not accessible, but token is in hash');
                    console.log('→ Attempting to trigger Decap CMS authentication manually...');
                    
                    // Try to access the CMS registry and manually set the token
                    try {
                      if (window.CMS.getRegistry) {
                        const registry = window.CMS.getRegistry();
                        console.log('→ Registry available, trying to access backend through registry...');
                        
                        // Try to get the backend implementation
                        if (registry.getBackend) {
                          const regBackend = registry.getBackend();
                          if (regBackend) {
                            console.log('→ Found backend through registry.getBackend()');
                            // Try to authenticate
                            if (regBackend.authenticate) {
                              regBackend.authenticate({
                                token: token,
                                token_type: tokenType || 'bearer',
                                provider: 'github'
                              }).then(function() {
                                console.log('✓ Authentication successful via registry backend');
                                window.location.reload();
                              }).catch(function(err) {
                                console.log('✗ Registry backend authentication failed:', err);
                              });
                            }
                          }
                        }
                      }
                    } catch(e) {
                      console.log('→ Could not access registry:', e.message);
                    }
                    
                    // Log what we can access for debugging
                    if (window.CMS) {
                      console.log('→ CMS object keys:', Object.keys(window.CMS));
                      console.log('→ Note: Backend may initialize later, token is in hash for when it does');
                    }
                  }
                } catch(e) {
                  console.log('→ Error accessing backend:', e.message);
                  console.log('→ Error stack:', e.stack);
                }
              }
            }, 1000);
            
            // Stop checking after 15 seconds
            setTimeout(function() {
              clearInterval(checkInterval);
              console.log('⚠️ Stopped checking for backend after 15 seconds');
              console.log('→ Token is in hash but Decap CMS may not be reading it');
              console.log('→ With auth_endpoint, Decap CMS expects token from endpoint response, not hash');
            }, 15000);
          }
        } catch(e) {
          console.error('Error parsing hash:', e);
        }
      } else {
        console.log('→ No token in hash on page load');
      }
      
      // Also check Decap CMS config
      setTimeout(function() {
        if (window.CMS) {
          console.log('✓ Decap CMS loaded successfully');
          try {
            const config = window.CMS.getConfig();
            if (config && config.backend) {
              console.log('Backend:', config.backend.name);
              console.log('Auth endpoint:', config.backend.auth_endpoint || 'not set');
              if (config.backend.auth_endpoint) {
                console.log('✓ Using auth_endpoint - OAuth proxy mode');
                console.log('⚠️ Note: With auth_endpoint, Decap CMS expects token from endpoint response, not hash');
              } else {
                console.log('⚠️ No auth_endpoint - may use direct OAuth');
              }
            }
          } catch(e) {
            console.log('Could not access Decap CMS config:', e.message);
            console.log('→ This may be normal - Decap CMS API may not be fully initialized yet');
          }
        } else {
          console.log('⚠️ Decap CMS not found');
        }
      }, 2000);
    });
    
    // Monitor authentication state changes
    let authCheckInterval = setInterval(function() {
      const loginButton = document.querySelector('button[class*="login"], a[class*="login"]');
      const cmsContent = document.querySelector('[class*="nc-root"], [class*="cms"]');
      
      if (loginButton && loginButton.offsetParent !== null) {
        console.log('→ Showing login screen');
      } else if (cmsContent) {
        console.log('✓ Decap CMS dashboard loaded - authentication successful!');
        clearInterval(authCheckInterval);
      }
    }, 2000);
    
    // Stop checking after 30 seconds
    setTimeout(function() {
      clearInterval(authCheckInterval);
    }, 30000);
  </script>
</head>
<body>
  <div id="nc-root"></div>
  <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
</body>
</html>
