<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // COMPLETELY PREVENT Decap CMS from adding #/ to hash
    // Intercept history API and continuously monitor hash
    (function() {
      // Intercept history.pushState and history.replaceState
      const originalPushState = history.pushState;
      const originalReplaceState = history.replaceState;
      
      function fixHashInURL(url) {
        if (!url) return url;
        
        // If URL has a hash, fix it
        const hashIndex = url.indexOf('#');
        if (hashIndex !== -1) {
          const hash = url.substring(hashIndex);
          let fixedHash = hash;
          
          // Remove / after # if present
          if (hash === '#/' || hash === '#') {
            // Remove hash completely
            return url.substring(0, hashIndex);
          } else if (hash.startsWith('#/')) {
            // Remove the / after #
            fixedHash = '#' + hash.substring(2);
            return url.substring(0, hashIndex) + fixedHash;
          }
        }
        return url;
      }
      
      history.pushState = function(state, title, url) {
        url = fixHashInURL(url);
        return originalPushState.call(this, state, title, url);
      };
      
      history.replaceState = function(state, title, url) {
        url = fixHashInURL(url);
        return originalReplaceState.call(this, state, title, url);
      };
      
      // Aggressive continuous monitoring to catch and fix hash changes immediately
      let lastHash = window.location.hash;
      let fixingHash = false;
      
      function fixHash() {
        if (fixingHash) return; // Prevent infinite loops
        fixingHash = true;
        
        const currentHash = window.location.hash;
        
        // If hash is #/ or #, remove it completely
        if (currentHash === '#/' || currentHash === '#') {
          history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        // If hash starts with #/, remove the /
        else if (currentHash.startsWith('#/')) {
          const fixedHash = currentHash.substring(2); // Remove #/
          history.replaceState(null, '', window.location.pathname + window.location.search + '#' + fixedHash);
        }
        
        fixingHash = false;
        lastHash = window.location.hash;
      }
      
      // Monitor hash changes very frequently
      setInterval(fixHash, 5); // Check every 5ms
      
      // Also listen for hashchange events
      window.addEventListener('hashchange', fixHash, true); // Capture phase
      
      // Fix hash immediately on load
      setTimeout(fixHash, 0);
      setTimeout(fixHash, 10);
      setTimeout(fixHash, 50);
      setTimeout(fixHash, 100);
      setTimeout(fixHash, 200);
      setTimeout(fixHash, 500);
      
      // Listen for postMessage from OAuth popup
      let receivedToken = null;
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          receivedToken = token;
          
          console.log('Token received via postMessage:', token.substring(0, 10) + '...');
          
          // Store token for later use
          sessionStorage.setItem('github_oauth_token', token);
          
          // Set token in hash with CORRECT format: #access_token=... (NO /)
          // Use history.replaceState to bypass normal hash setter
          history.replaceState(null, '', window.location.pathname + window.location.search + '#access_token=' + encodeURIComponent(token) + '&token_type=bearer');
          
          // Ensure it stays fixed
          setTimeout(fixHash, 10);
          setTimeout(fixHash, 50);
          
          // Try to authenticate immediately if CMS is ready
          if (window.CMS) {
            setTimeout(function() {
              checkAndAuthenticate();
            }, 100);
          }
        }
      });
    })();
  </script>
  
  <script>
    // Extract token from hash and manually authenticate Decap CMS
    (function() {
      function getTokenFromHash() {
        const hash = window.location.hash;
        if (!hash || !hash.includes('access_token=')) {
          return null;
        }
        
        // Extract token from hash
        const hashStr = hash.substring(1); // Remove #
        const params = new URLSearchParams(hashStr);
        return params.get('access_token');
      }
      
      function authenticateDecapCMS(token) {
        if (!window.CMS) {
          console.log('CMS not available yet');
          return false;
        }
        
        try {
          console.log('Attempting to authenticate with token:', token.substring(0, 10) + '...');
          
          // Get the backend - try multiple methods
          let backend = null;
          try {
            backend = window.CMS.getBackend();
          } catch(e) {
            console.log('Error calling getBackend():', e);
          }
          
          // If backend not available, try alternative methods
          if (!backend) {
            console.log('Backend not available via getBackend(), trying alternatives...');
            
            // Try accessing through store
            if (window.CMS.store) {
              const store = window.CMS.store;
              if (store.getState) {
                const state = store.getState();
                console.log('Store state:', state);
                
                // Try to find backend in state
                if (state.config && state.config.backend) {
                  console.log('Found backend config in state');
                }
                
                // Try to dispatch authentication action directly
                if (store.dispatch) {
                  try {
                    // Try different action types
                    store.dispatch({ 
                      type: 'AUTH_SUCCESS', 
                      payload: { token: token, provider: 'github' } 
                    });
                    console.log('✓ Dispatched AUTH_SUCCESS action');
                    
                    store.dispatch({ 
                      type: 'AUTHENTICATE_SUCCESS', 
                      payload: { token: token } 
                    });
                    console.log('✓ Dispatched AUTHENTICATE_SUCCESS action');
                    
                    store.dispatch({ 
                      type: 'AUTH_USER', 
                      payload: { token: token } 
                    });
                    console.log('✓ Dispatched AUTH_USER action');
                  } catch(e) {
                    console.log('Could not dispatch actions:', e);
                  }
                }
              }
            }
            
            // Try accessing backend through registry
            if (window.CMS.registry) {
              try {
                if (window.CMS.registry.getBackend) {
                  backend = window.CMS.registry.getBackend('github');
                  console.log('Got backend from registry');
                }
              } catch(e) {
                console.log('Could not get backend from registry:', e);
              }
            }
            
            // If still no backend, return but keep trying
            if (!backend) {
              console.log('Backend still not available, will retry...');
              return false;
            }
          }
          
          console.log('Backend found:', backend);
          console.log('Backend type:', backend ? backend.constructor.name : 'unknown');
          
          // Try to access the GitHub backend implementation directly
          // Decap CMS GitHub backend stores token in different places
          
          // Method 1: Try setting token on backend directly
          if (backend.token !== undefined) {
            backend.token = token;
            console.log('✓ Token set on backend.token');
          }
          
          // Method 2: Try accessing implementation property
          if (backend.implementation) {
            console.log('Backend implementation found:', backend.implementation);
            
            // Try setting token on implementation
            if (backend.implementation.token !== undefined) {
              backend.implementation.token = token;
              console.log('✓ Token set on backend.implementation.token');
            }
            
            if (backend.implementation.authToken !== undefined) {
              backend.implementation.authToken = token;
              console.log('✓ Token set on backend.implementation.authToken');
            }
            
            // Try calling authenticate on implementation
            if (typeof backend.implementation.authenticate === 'function') {
              backend.implementation.authenticate({ token: token });
              console.log('✓ Called backend.implementation.authenticate');
            }
          }
          
          // Method 3: Try authenticate method
          if (typeof backend.authenticate === 'function') {
            backend.authenticate({ token: token, provider: 'github' });
            console.log('✓ Called backend.authenticate');
          }
          
          // Method 4: Try restoreUser
          if (typeof backend.restoreUser === 'function') {
            backend.restoreUser();
            console.log('✓ Called backend.restoreUser');
          }
          
          // Method 5: Try to trigger authentication by setting user
          if (backend.user !== undefined) {
            // Try to set a mock user to trigger auth check
            console.log('Backend has user property');
          }
          
          // Method 6: Access internal _token or _authToken
          if (backend._token !== undefined) {
            backend._token = token;
            console.log('✓ Token set on backend._token');
          }
          
          if (backend._authToken !== undefined) {
            backend._authToken = token;
            console.log('✓ Token set on backend._authToken');
          }
          
          // Method 7: Try to access the store and set token there
          if (window.CMS.store) {
            const store = window.CMS.store;
            if (store.getState) {
              const state = store.getState();
              console.log('Store state:', state);
              
              // Try to dispatch an action to set the token
              if (store.dispatch) {
                try {
                  store.dispatch({ type: 'AUTH_SUCCESS', payload: { token: token } });
                  console.log('✓ Dispatched AUTH_SUCCESS action');
                } catch(e) {
                  console.log('Could not dispatch action:', e);
                }
              }
            }
          }
          
          // Method 8: Force a reload of the backend
          if (typeof backend.init === 'function') {
            backend.init({ token: token });
            console.log('✓ Called backend.init with token');
          }
          
          // Method 9: Try to access through CMS registry
          if (window.CMS.registry) {
            try {
              const githubBackend = window.CMS.registry.getBackend('github');
              if (githubBackend) {
                if (githubBackend.token !== undefined) {
                  githubBackend.token = token;
                  console.log('✓ Token set on registry backend');
                }
                if (typeof githubBackend.authenticate === 'function') {
                  githubBackend.authenticate({ token: token });
                  console.log('✓ Called registry backend.authenticate');
                }
              }
            } catch(e) {
              console.log('Could not access backend through registry:', e);
            }
          }
          
          // Method 10: Try to manually set authentication in store
          if (window.CMS.store && window.CMS.store.dispatch) {
            try {
              // Try to set the user/authentication state directly
              const actions = [
                { type: 'AUTHENTICATE_USER', payload: { token: token } },
                { type: 'SET_USER', payload: { token: token } },
                { type: 'AUTH_SUCCESS', payload: { token: token, provider: 'github' } },
                { type: 'GITHUB_AUTH_SUCCESS', payload: { token: token } }
              ];
              
              actions.forEach(action => {
                try {
                  window.CMS.store.dispatch(action);
                  console.log('✓ Dispatched', action.type);
                } catch(e) {
                  // Ignore errors
                }
              });
            } catch(e) {
              console.log('Could not dispatch store actions:', e);
            }
          }
          
          return true;
        } catch(e) {
          console.error('Error authenticating Decap CMS:', e);
          console.error('Error stack:', e.stack);
          return false;
        }
      }
      
      // Check for token and authenticate
      let attemptCount = 0;
      const maxAttempts = 100; // Try for 20 seconds (100 * 200ms)
      let backendReady = false;
      let authenticationAttempted = false;
      
      function checkAndAuthenticate() {
        attemptCount++;
        
        // Get token from hash or sessionStorage
        let token = getTokenFromHash();
        if (!token) {
          token = sessionStorage.getItem('github_oauth_token');
        }
        
        if (!token) {
          if (attemptCount < maxAttempts) {
            setTimeout(checkAndAuthenticate, 200);
          }
          return;
        }
        
        // Wait for Decap CMS to be fully loaded
        if (!window.CMS) {
          console.log('Waiting for CMS to load... (attempt ' + attemptCount + ')');
          if (attemptCount < maxAttempts) {
            setTimeout(checkAndAuthenticate, 200);
          }
          return;
        }
        
        // Try to get backend - it might not be ready immediately
        let backend = null;
        try {
          backend = window.CMS.getBackend();
        } catch(e) {
          console.log('Error getting backend:', e);
        }
        
        if (!backend) {
          console.log('Waiting for backend to be ready... (attempt ' + attemptCount + ')');
          
          // Try alternative ways to access backend
          if (window.CMS.store) {
            const store = window.CMS.store;
            if (store.getState) {
              const state = store.getState();
              // Backend might be in the store
              if (state.config && state.config.backend) {
                console.log('Found backend in store state');
                backendReady = true;
              }
            }
          }
          
          // Try accessing backend through registry
          if (window.CMS.registry && window.CMS.registry.getBackend) {
            try {
              backend = window.CMS.registry.getBackend('github');
              console.log('Got backend from registry');
            } catch(e) {
              console.log('Could not get backend from registry');
            }
          }
          
          if (!backend && attemptCount < maxAttempts) {
            setTimeout(checkAndAuthenticate, 200);
            return;
          }
        } else {
          backendReady = true;
          console.log('Backend is ready!');
        }
        
        if (backend || backendReady) {
          if (!authenticationAttempted) {
            console.log('Token found, attempting to authenticate Decap CMS... (attempt ' + attemptCount + ')');
            authenticationAttempted = true;
          }
          
          const authenticated = authenticateDecapCMS(token);
          if (authenticated) {
            console.log('Decap CMS authentication attempted');
            // Don't clear hash yet - let Decap CMS process it
          }
          
          // Keep trying even after first attempt to ensure it sticks
          if (attemptCount < maxAttempts) {
            setTimeout(checkAndAuthenticate, 500);
          }
        } else {
          // Backend not ready yet
          if (attemptCount < maxAttempts) {
            setTimeout(checkAndAuthenticate, 200);
          } else if (attemptCount >= maxAttempts && !authenticationAttempted) {
            console.warn('Backend did not become available after ' + maxAttempts + ' attempts');
            console.warn('CMS object:', window.CMS);
            console.warn('Available methods:', Object.keys(window.CMS || {}));
            
            // Try one more time with a longer delay
            if (attemptCount < maxAttempts + 10) {
              setTimeout(checkAndAuthenticate, 1000);
            }
          }
        }
      }
      
      // Wait longer for Decap CMS to fully initialize
      // Start checking after a delay to let Decap CMS load
      setTimeout(checkAndAuthenticate, 2000); // Wait 2 seconds first
      setTimeout(checkAndAuthenticate, 3000);
      setTimeout(checkAndAuthenticate, 4000);
      setTimeout(checkAndAuthenticate, 5000);
      
      // Also check when hash changes (in case token is added after page load)
      window.addEventListener('hashchange', function() {
        attemptCount = 0; // Reset counter
        backendReady = false;
        setTimeout(checkAndAuthenticate, 500);
      });
      
      // Listen for CMS ready event if it exists
      if (window.CMS && window.CMS.events) {
        window.CMS.events.subscribe('CMS_READY', function() {
          console.log('CMS_READY event fired');
          setTimeout(checkAndAuthenticate, 500);
        });
      }
    })();
  </script>
  
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
