<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // COMPLETELY PREVENT Decap CMS from adding #/ to hash
    // Intercept history API and continuously monitor hash
    (function() {
      // Intercept history.pushState and history.replaceState
      const originalPushState = history.pushState;
      const originalReplaceState = history.replaceState;
      
      function fixHashInURL(url) {
        if (!url) return url;
        
        // If URL has a hash, fix it
        const hashIndex = url.indexOf('#');
        if (hashIndex !== -1) {
          const hash = url.substring(hashIndex);
          let fixedHash = hash;
          
          // Remove / after # if present
          if (hash === '#/' || hash === '#') {
            // Remove hash completely
            return url.substring(0, hashIndex);
          } else if (hash.startsWith('#/')) {
            // Remove the / after #
            fixedHash = '#' + hash.substring(2);
            return url.substring(0, hashIndex) + fixedHash;
          }
        }
        return url;
      }
      
      history.pushState = function(state, title, url) {
        url = fixHashInURL(url);
        return originalPushState.call(this, state, title, url);
      };
      
      history.replaceState = function(state, title, url) {
        url = fixHashInURL(url);
        return originalReplaceState.call(this, state, title, url);
      };
      
      // Aggressive continuous monitoring to catch and fix hash changes immediately
      let lastHash = window.location.hash;
      let fixingHash = false;
      
      function fixHash() {
        if (fixingHash) return; // Prevent infinite loops
        fixingHash = true;
        
        const currentHash = window.location.hash;
        
        // If hash is #/ or #, remove it completely
        if (currentHash === '#/' || currentHash === '#') {
          history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        // If hash starts with #/, remove the /
        else if (currentHash.startsWith('#/')) {
          const fixedHash = currentHash.substring(2); // Remove #/
          history.replaceState(null, '', window.location.pathname + window.location.search + '#' + fixedHash);
        }
        
        fixingHash = false;
        lastHash = window.location.hash;
      }
      
      // Monitor hash changes very frequently
      setInterval(fixHash, 5); // Check every 5ms
      
      // Also listen for hashchange events
      window.addEventListener('hashchange', fixHash, true); // Capture phase
      
      // Fix hash immediately on load
      setTimeout(fixHash, 0);
      setTimeout(fixHash, 10);
      setTimeout(fixHash, 50);
      setTimeout(fixHash, 100);
      setTimeout(fixHash, 200);
      setTimeout(fixHash, 500);
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          
          // Set token in hash with CORRECT format: #access_token=... (NO /)
          // Use history.replaceState to bypass normal hash setter
          history.replaceState(null, '', window.location.pathname + window.location.search + '#access_token=' + encodeURIComponent(token) + '&token_type=bearer');
          
          // Ensure it stays fixed
          setTimeout(fixHash, 10);
          setTimeout(fixHash, 50);
        }
      });
    })();
  </script>
  
  <script>
    // Extract token from hash and manually authenticate Decap CMS
    (function() {
      function getTokenFromHash() {
        const hash = window.location.hash;
        if (!hash || !hash.includes('access_token=')) {
          return null;
        }
        
        // Extract token from hash
        const hashStr = hash.substring(1); // Remove #
        const params = new URLSearchParams(hashStr);
        return params.get('access_token');
      }
      
      function authenticateDecapCMS(token) {
        if (!window.CMS) {
          return false;
        }
        
        try {
          // Get the backend
          const backend = window.CMS.getBackend();
          if (!backend) {
            return false;
          }
          
          // Try different methods to authenticate
          // Method 1: Set token directly on backend
          if (backend.token !== undefined) {
            backend.token = token;
            console.log('Token set on backend.token');
          }
          
          // Method 2: Use authenticate method if available
          if (typeof backend.authenticate === 'function') {
            backend.authenticate({ token: token, provider: 'github' });
            console.log('Called backend.authenticate');
          }
          
          // Method 3: Use restoreUser to restore session
          if (typeof backend.restoreUser === 'function') {
            backend.restoreUser();
            console.log('Called backend.restoreUser');
          }
          
          // Method 4: Try to access internal auth methods
          if (backend.implementation && backend.implementation.authToken !== undefined) {
            backend.implementation.authToken = token;
            console.log('Token set on backend.implementation.authToken');
          }
          
          // Method 5: Trigger a manual login
          if (backend.login && typeof backend.login === 'function') {
            backend.login({ token: token });
            console.log('Called backend.login');
          }
          
          return true;
        } catch(e) {
          console.error('Error authenticating Decap CMS:', e);
          return false;
        }
      }
      
      // Check for token and authenticate
      function checkAndAuthenticate() {
        const token = getTokenFromHash();
        if (!token) {
          return;
        }
        
        console.log('Token found in hash, attempting to authenticate Decap CMS...');
        
        // Wait for Decap CMS to initialize
        if (window.CMS && window.CMS.getBackend) {
          const authenticated = authenticateDecapCMS(token);
          if (authenticated) {
            console.log('Decap CMS authentication attempted');
            // Clear hash after authentication attempt
            setTimeout(function() {
              if (window.location.hash.includes('access_token=')) {
                history.replaceState(null, '', window.location.pathname + window.location.search);
              }
            }, 1000);
          }
        } else {
          // Decap CMS not ready, try again
          setTimeout(checkAndAuthenticate, 200);
        }
      }
      
      // Start checking after page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(checkAndAuthenticate, 1000);
        });
      } else {
        setTimeout(checkAndAuthenticate, 1000);
      }
      
      // Also check when hash changes (in case token is added after page load)
      window.addEventListener('hashchange', function() {
        setTimeout(checkAndAuthenticate, 100);
      });
    })();
  </script>
  
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
