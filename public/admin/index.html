<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // COMPLETELY PREVENT Decap CMS from adding #/ to hash
    // Override hash routing behavior at the source
    (function() {
      // Store original location.hash setter
      let hashValue = window.location.hash;
      
      // Override window.location.hash setter to intercept all hash changes
      Object.defineProperty(window.location, 'hash', {
        get: function() {
          return hashValue;
        },
        set: function(newHash) {
          // Remove any leading / after #
          if (newHash && newHash.startsWith('#')) {
            // If it's just #/, set to empty (no hash)
            if (newHash === '#/' || newHash === '#') {
              hashValue = '';
              window.history.replaceState(null, null, window.location.pathname + window.location.search);
              return;
            }
            
            // If it starts with #/, remove the /
            if (newHash.startsWith('#/')) {
              newHash = '#' + newHash.substring(2);
            }
          }
          
          hashValue = newHash;
          
          // Update URL without triggering navigation
          if (newHash && newHash !== '#') {
            window.history.replaceState(null, null, window.location.pathname + window.location.search + newHash);
          } else {
            window.history.replaceState(null, null, window.location.pathname + window.location.search);
          }
          
          // Trigger hashchange event manually so Decap CMS still gets notified
          window.dispatchEvent(new HashChangeEvent('hashchange', {
            oldURL: window.location.href,
            newURL: window.location.href
          }));
        },
        configurable: true
      });
      
      // Also intercept history.pushState and history.replaceState
      const originalPushState = history.pushState;
      const originalReplaceState = history.replaceState;
      
      function fixHashInState(state, title, url) {
        if (url && url.includes('#')) {
          const hashIndex = url.indexOf('#');
          const hash = url.substring(hashIndex);
          if (hash.startsWith('#/')) {
            url = url.substring(0, hashIndex) + '#' + hash.substring(2);
          } else if (hash === '#/' || hash === '#') {
            url = url.substring(0, hashIndex);
          }
        }
        return url;
      }
      
      history.pushState = function(state, title, url) {
        url = fixHashInState(state, title, url);
        hashValue = url && url.includes('#') ? url.substring(url.indexOf('#')) : '';
        return originalPushState.call(this, state, title, url);
      };
      
      history.replaceState = function(state, title, url) {
        url = fixHashInState(state, title, url);
        hashValue = url && url.includes('#') ? url.substring(url.indexOf('#')) : '';
        return originalReplaceState.call(this, state, title, url);
      };
      
      // Continuous monitoring to catch any hash changes we might miss
      let lastHash = window.location.hash;
      setInterval(function() {
        const currentHash = window.location.hash;
        
        // If hash changed and now has #/, fix it immediately
        if (currentHash !== lastHash) {
          if (currentHash === '#/' || currentHash === '#') {
            window.location.hash = '';
          } else if (currentHash.startsWith('#/')) {
            window.location.hash = currentHash.substring(2);
          }
          lastHash = window.location.hash;
        }
      }, 10); // Check every 10ms for maximum responsiveness
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          
          // Set token in hash with CORRECT format: #access_token=... (NO /)
          window.location.hash = 'access_token=' + encodeURIComponent(token) + '&token_type=bearer';
        }
      });
      
      // Fix initial hash if it has #/
      if (window.location.hash === '#/' || window.location.hash === '#') {
        window.location.hash = '';
      } else if (window.location.hash.startsWith('#/')) {
        window.location.hash = window.location.hash.substring(2);
      }
    })();
  </script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
