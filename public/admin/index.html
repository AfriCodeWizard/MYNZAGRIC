<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // CRITICAL: Extract token from hash BEFORE Decap CMS loads
    // Decap CMS router will add #/ which overwrites the token
    (function() {
      // Extract token from hash immediately (before Decap CMS loads)
      function extractTokenFromHash() {
        const hash = window.location.hash;
        if (!hash || !hash.includes('access_token=')) {
          return null;
        }
        
        // Remove # and any leading / - handle both #/access_token and #access_token
        const hashStr = hash.substring(1).replace(/^\/+/, '');
        const params = new URLSearchParams(hashStr);
        return params.get('access_token');
      }
      
      // Extract and store token BEFORE Decap CMS loads
      const token = extractTokenFromHash();
      if (token) {
        console.log('Token extracted from hash before Decap CMS loads');
        // Store in sessionStorage so we can use it after Decap CMS initializes
        sessionStorage.setItem('github_oauth_token', token);
        // Also store the full token data
        sessionStorage.setItem('github_token_data', JSON.stringify({
          access_token: token,
          token_type: 'bearer',
          provider: 'github'
        }));
        
        // Clear the hash so Decap CMS doesn't interfere with it
        // We'll inject the token manually after Decap CMS loads
        window.history.replaceState(null, null, window.location.pathname);
      }
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          
          // Store token before reload
          sessionStorage.setItem('github_oauth_token', token);
          sessionStorage.setItem('github_token_data', JSON.stringify({
            access_token: token,
            token_type: 'bearer',
            provider: 'github'
          }));
          
          // Reload - token will be extracted on next load
          window.location.reload();
        }
      });
    })();
  </script>
  
  <script>
    // After Decap CMS loads, inject the token
    (function() {
      // Wait for Decap CMS to initialize
      function injectToken() {
        const tokenData = sessionStorage.getItem('github_token_data');
        if (!tokenData) {
          return;
        }
        
        try {
          const tokenObj = JSON.parse(tokenData);
          const token = tokenObj.access_token;
          
          // Check if Decap CMS is loaded
          if (window.CMS && window.CMS.getBackend) {
            try {
              const backend = window.CMS.getBackend();
              if (backend) {
                // Try to authenticate with the token
                // Decap CMS GitHub backend expects token in specific format
                if (backend.authenticate) {
                  console.log('Attempting to authenticate Decap CMS with stored token...');
                  backend.authenticate({ 
                    token: token,
                    provider: 'github'
                  });
                } else if (backend.authToken !== undefined) {
                  // Try setting authToken directly
                  backend.authToken = token;
                  console.log('Token set directly on backend');
                } else if (backend.token !== undefined) {
                  // Try setting token directly
                  backend.token = token;
                  console.log('Token set on backend.token');
                }
                
                // Trigger a refresh/re-authentication
                if (backend.restoreUser) {
                  backend.restoreUser();
                }
                
                // Clear stored token after use
                sessionStorage.removeItem('github_oauth_token');
                sessionStorage.removeItem('github_token_data');
              }
            } catch(e) {
              console.error('Error injecting token into Decap CMS:', e);
            }
          } else {
            // Decap CMS not ready yet, try again
            setTimeout(injectToken, 200);
          }
        } catch(e) {
          console.error('Error parsing token data:', e);
        }
      }
      
      // Start trying to inject token after page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(injectToken, 1000); // Wait 1 second for Decap CMS to initialize
        });
      } else {
        setTimeout(injectToken, 1000);
      }
    })();
  </script>
  
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
