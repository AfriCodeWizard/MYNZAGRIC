<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/site.webmanifest" />
  <title>Content Manager</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    #nc-root {
      min-height: 100vh;
    }
    .auth-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      flex-direction: column;
      gap: 1rem;
    }
    .auth-loading.hidden {
      display: none;
    }
  </style>
  <script>
    // CRITICAL: This script runs IMMEDIATELY in head, before Decap CMS loads
    // It ensures the token is in the hash before Decap CMS can initialize
    
    (function() {
      console.log('=== Decap CMS Auth Initialization (HEAD) ===');
      console.log('Initial URL:', window.location.href);
      console.log('Initial hash:', window.location.hash);
      console.log('Initial search:', window.location.search);
      
      const hash = window.location.hash;
      const search = window.location.search;
      let token = null;
      
      // Extract token from hash if present (from proxy redirect)
      // Decap CMS uses #/token= format, but we also support #token= for initial redirects
      if (hash && hash.includes('token=')) {
        if (hash.startsWith('#token=')) {
          token = decodeURIComponent(hash.replace('#token=', ''));
          console.log('✓ Token found in hash (#token= format)');
          // Convert to Decap CMS format: #/token=
          window.location.replace(window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(token));
          return; // Exit - page will reload with correct format
        } else if (hash.startsWith('#/token=')) {
          token = decodeURIComponent(hash.replace('#/token=', ''));
          console.log('✓ Token found in hash (#/token= format - Decap CMS format)');
          // This is the correct format for Decap CMS, keep it
        } else {
          // Try to extract from hash
          const match = hash.match(/token=([^&]+)/);
          if (match) {
            token = decodeURIComponent(match[1]);
            console.log('⚠ Token found but format needs fixing, converting to Decap CMS format');
            window.location.replace(window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(token));
            return;
          }
        }
      }
      
      // Check for OAuth code in query params (direct GitHub OAuth callback)
      // Decap CMS will handle this, but we can log it for debugging
      if (search && search.includes('code=') && !token) {
        console.log('✓ OAuth code found in query params - Decap CMS will handle authentication');
        // Decap CMS will process this automatically
      }
      
      // If no token in hash, try to recover from storage
      if (!token) {
        console.log('⚠ No token in hash, attempting recovery...');
        
        // Try localStorage
        try {
          token = localStorage.getItem('github_token');
          if (token) {
            console.log('✓ Token recovered from localStorage');
            localStorage.removeItem('github_token');
            window.location.replace(window.location.pathname + window.location.search + '#token=' + encodeURIComponent(token));
            return;
          }
        } catch (e) {
          console.error('Failed to read localStorage:', e);
        }
        
        // Try sessionStorage
        try {
          token = sessionStorage.getItem('github_token');
          if (token) {
            console.log('✓ Token recovered from sessionStorage');
            sessionStorage.removeItem('github_token');
            window.location.replace(window.location.pathname + window.location.search + '#token=' + encodeURIComponent(token));
            return;
          }
        } catch (e) {
          console.error('Failed to read sessionStorage:', e);
        }
        
        // Try cookie
        try {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('github_token=')) {
              token = decodeURIComponent(cookie.substring('github_token='.length));
              console.log('✓ Token recovered from cookie');
              document.cookie = 'github_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
              window.location.replace(window.location.pathname + window.location.search + '#token=' + encodeURIComponent(token));
              return;
            }
          }
        } catch (e) {
          console.error('Failed to read cookie:', e);
        }
        
        // Try API endpoint as last resort (only if coming from OAuth redirect)
        if (document.referrer && document.referrer.includes('/api/auth')) {
          console.log('Attempting to fetch token from API endpoint...');
          fetch('/api/token')
            .then(response => {
              if (response.ok) {
                return response.json();
              }
              throw new Error('Token not found');
            })
            .then(data => {
              if (data.token) {
                console.log('✓ Token recovered from API');
                window.location.replace(window.location.pathname + window.location.search + '#token=' + encodeURIComponent(data.token));
              } else {
                console.log('⚠ No token in API response - user needs to log in');
              }
            })
            .catch(e => {
              console.log('⚠ Could not fetch token from API:', e.message);
              console.log('Decap CMS will load and show login page');
            });
        }
      }
      
      // If we have a token, ensure it's in the hash BEFORE Decap CMS loads
      if (token) {
        console.log('✓ Token confirmed, length:', token.length);
        
        // CRITICAL: Ensure token is in hash in Decap CMS format (#/token=) BEFORE Decap CMS loads
        const currentHash = window.location.hash;
        if (!currentHash.startsWith('#/token=')) {
          console.log('→ Setting token in hash in Decap CMS format (#/token=) before Decap CMS loads...');
          const newUrl = window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(token);
          window.history.replaceState(null, '', newUrl);
          console.log('✓ Token set in hash - Decap CMS will read it on initialization');
        } else {
          console.log('✓ Token already in hash in correct format (#/token=)');
        }
        
        // Store token globally so it can be restored if needed
        window.__DECAP_TOKEN__ = token;
        
        // Monitor hash to restore token if Decap CMS clears it
        // Note: Decap CMS uses #/token= format, not #token=
        let hashMonitorCount = 0;
        const hashMonitor = setInterval(function() {
          hashMonitorCount++;
          const currentHash = window.location.hash;
          const hasToken = currentHash && (currentHash.startsWith('#token=') || currentHash.startsWith('#/token='));
          if (!hasToken) {
            if (window.__DECAP_TOKEN__) {
              console.log('⚠ Hash cleared (check #' + hashMonitorCount + '), restoring token in Decap CMS format...');
              // Use Decap CMS format: #/token=
              const newUrl = window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(window.__DECAP_TOKEN__);
              window.history.replaceState(null, '', newUrl);
              console.log('✓ Token restored in hash (#/token= format)');
            }
          }
          // Stop monitoring after 30 seconds
          if (hashMonitorCount > 300) {
            clearInterval(hashMonitor);
            console.log('Hash monitoring stopped after 30 seconds');
          }
        }, 100);
      } else {
        console.log('⚠ No token found - Decap CMS will show login page');
        // Still allow Decap CMS to load so user can log in
      }
    })();
  </script>
  <script>
    // Load Decap CMS after DOM is ready and token is in hash
    (function() {
      function loadDecapCMS() {
        console.log('=== loadDecapCMS() called ===');
        
        // Verify #nc-root exists
        const ncRoot = document.getElementById('nc-root');
        if (!ncRoot) {
          console.error('✗ #nc-root element not found, retrying...');
          // Retry after a short delay
          setTimeout(loadDecapCMS, 50);
          return;
        }
        console.log('✓ #nc-root element found');
        
        // Check if token is in hash (optional - Decap CMS can show login page if no token)
        // Decap CMS uses #/token= format
        const hash = window.location.hash;
        console.log('Current hash:', hash);
        let tokenFromHash = null;
        if (hash) {
          if (hash.startsWith('#token=')) {
            tokenFromHash = hash.replace('#token=', '');
            console.log('✓ Token found in hash (#token= format), length:', tokenFromHash.length);
          } else if (hash.startsWith('#/token=')) {
            tokenFromHash = hash.replace('#/token=', '');
            console.log('✓ Token found in hash (#/token= format - Decap CMS format), length:', tokenFromHash.length);
          }
        }
        
        if (tokenFromHash) {
          console.log('✓ DOM ready, #nc-root exists, token in hash - loading Decap CMS');
        } else {
          console.log('⚠ No token in hash');
          console.log('✓ DOM ready, #nc-root exists, no token - loading Decap CMS (will show login page)');
        }
        
        console.log('→ Creating Decap CMS script element...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js';
        script.async = true;
        
        script.onload = function() {
          console.log('✓ Decap CMS script loaded successfully');
          console.log('→ Waiting for Decap CMS to initialize...');
          
          // Check hash after Decap CMS loads and ensure it authenticates
          setTimeout(function() {
            const hashAfterLoad = window.location.hash;
            console.log('Hash after Decap CMS load:', hashAfterLoad);
            
            // Check if token is in hash (handle both #token= and #/token= formats)
            let tokenInHash = null;
            if (hashAfterLoad) {
              if (hashAfterLoad.startsWith('#token=')) {
                tokenInHash = hashAfterLoad.replace('#token=', '');
                console.log('✓ Token found in hash (#token= format)');
                // Convert to Decap CMS format
                const newUrl = window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(tokenInHash);
                window.history.replaceState(null, '', newUrl);
                console.log('→ Converted to Decap CMS format (#/token=)');
                tokenInHash = decodeURIComponent(hashAfterLoad.replace('#token=', ''));
              } else if (hashAfterLoad.startsWith('#/token=')) {
                tokenInHash = decodeURIComponent(hashAfterLoad.replace('#/token=', ''));
                console.log('✓ Token found in hash (#/token= format - Decap CMS format)');
                // Decap CMS uses #/token= format, this is correct!
              } else {
                // Try to extract token from hash
                const match = hashAfterLoad.match(/token=([^&]+)/);
                if (match) {
                  tokenInHash = decodeURIComponent(match[1]);
                  console.log('✓ Token extracted from hash');
                }
              }
            }
            
            if (tokenInHash) {
              console.log('✓ Token present in hash, length:', tokenInHash.length);
              console.log('→ Decap CMS should authenticate with this token');
              
              // Ensure token is in Decap CMS format
              if (!hashAfterLoad.startsWith('#/token=')) {
                console.log('→ Ensuring token is in Decap CMS format...');
                const newUrl = window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(tokenInHash);
                window.history.replaceState(null, '', newUrl);
                console.log('✓ Token format corrected');
              }
              
              // Try to trigger Decap CMS authentication by dispatching hashchange event
              // This might help Decap CMS detect the token
              console.log('→ Dispatching hashchange event to trigger Decap CMS authentication...');
              window.dispatchEvent(new HashChangeEvent('hashchange'));
              
              // Log status but don't auto-reload (causes infinite loop)
              setTimeout(function() {
                console.log('→ Checking Decap CMS authentication status...');
                const ncRoot = document.getElementById('nc-root');
                if (ncRoot) {
                  const hasLoginButton = ncRoot.textContent && ncRoot.textContent.includes('Login');
                  if (hasLoginButton && tokenInHash) {
                    console.warn('⚠ Decap CMS still showing login page despite token in hash');
                    console.warn('→ Token is present but Decap CMS may not have read it');
                    console.warn('→ Try manually refreshing the page once');
                  } else {
                    console.log('✓ Decap CMS appears to have processed the token');
                  }
                }
              }, 3000);
            } else {
              console.warn('⚠ Token missing from hash after Decap CMS load');
              if (window.__DECAP_TOKEN__) {
                console.log('→ Attempting to restore token...');
                // Use Decap CMS format: #/token=
                const newUrl = window.location.pathname + window.location.search + '#/token=' + encodeURIComponent(window.__DECAP_TOKEN__);
                window.history.replaceState(null, '', newUrl);
                console.log('✓ Token restored in Decap CMS format (#/token=)');
                // Trigger hashchange to notify Decap CMS
                window.dispatchEvent(new HashChangeEvent('hashchange'));
              }
            }
          }, 2000);
        };
        
        script.onerror = function(e) {
          console.error('✗ Failed to load Decap CMS from unpkg:', e);
          console.log('→ Trying fallback CDN...');
          const fallback = document.createElement('script');
          fallback.src = 'https://cdn.jsdelivr.net/npm/decap-cms@3.9.0/dist/decap-cms.js';
          fallback.async = true;
          fallback.onload = function() {
            console.log('✓ Decap CMS loaded from fallback CDN');
          };
          fallback.onerror = function() {
            console.error('✗ All CDN attempts failed');
            const loadingDiv = document.getElementById('auth-loading');
            if (loadingDiv) {
              loadingDiv.classList.remove('hidden');
              loadingDiv.innerHTML = '<p style="color: #ef4444;">Failed to load Decap CMS. Please refresh the page.</p>';
            }
          };
          document.head.appendChild(fallback);
        };
        
        console.log('→ Appending Decap CMS script to head...');
        document.head.appendChild(script);
        console.log('✓ Script element appended');
      }
      
      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDecapCMS);
      } else {
        // DOM is already ready, but wait a tick to ensure #nc-root is rendered
        setTimeout(loadDecapCMS, 0);
      }
    })();
  </script>
  <!-- Decap CMS will be loaded after DOM is ready and token is confirmed -->
</head>
<body>
  <div id="nc-root"></div>
  <div id="auth-loading" class="auth-loading hidden">
    <p>Authenticating...</p>
  </div>
</body>
</html>
