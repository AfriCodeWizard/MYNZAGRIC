<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
  <script>
    // Minimal logging to verify OAuth flow with auth_endpoint
    console.log('=== Decap CMS Loading ===');
    console.log('Current URL:', window.location.href);
    console.log('Hash:', window.location.hash);
    
    // Check for stored token on page load (from previous OAuth)
    const storedToken = sessionStorage.getItem('decap_oauth_token');
    const storedProvider = sessionStorage.getItem('decap_oauth_provider');
    if (storedToken && !window.location.hash.includes('access_token')) {
      console.log('→ Found stored token, setting in hash...');
      window.location.hash = '#/access_token=' + encodeURIComponent(storedToken) + '&token_type=bearer';
      // Clear stored token
      sessionStorage.removeItem('decap_oauth_token');
      sessionStorage.removeItem('decap_oauth_provider');
    }
    
    // Listen for token from OAuth popup (when using auth_endpoint)
    window.addEventListener('message', function(event) {
      // Only accept messages from same origin
      if (event.origin !== window.location.origin) {
        return;
      }
      
      console.log('=== Message received from popup ===');
      console.log('Data:', event.data);
      
      // Check for token in message (from OAuth callback popup)
      if (event.data && (event.data.token || event.data.type === 'authorization')) {
        const token = event.data.token;
        const provider = event.data.provider || 'github';
        
        console.log('✓ Token received from OAuth popup!');
        console.log('Token length:', token ? token.length : 'missing');
        console.log('Provider:', provider);
        
        // Manually authenticate Decap CMS with the token
        if (token && window.CMS) {
          console.log('→ Attempting to authenticate Decap CMS with received token...');
          try {
            // Try to get the backend and authenticate
            const backend = window.CMS.getBackend();
            if (backend && backend.authenticate) {
              console.log('→ Calling backend.authenticate()...');
              backend.authenticate({
                token: token,
                provider: provider
              }).then(function() {
                console.log('✓ Authentication successful!');
                // Reload to show dashboard
                window.location.reload();
              }).catch(function(error) {
                console.error('✗ Authentication failed:', error);
                // Try alternative method - set token in backend state
                if (backend.tokenPromise) {
                  backend.tokenPromise = Promise.resolve(token);
                  console.log('→ Set tokenPromise, reloading...');
                  window.location.reload();
                }
              });
            } else {
              console.log('→ Backend.authenticate not available, trying alternative...');
              // Alternative: Set token directly in backend
              if (backend && backend.implementation) {
                backend.implementation.token = token;
                console.log('→ Set token in backend implementation, reloading...');
                window.location.reload();
              } else {
                // Last resort: Set token in URL hash and reload
                console.log('→ Setting token in URL hash and reloading...');
                window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
                setTimeout(function() {
                  window.location.reload();
                }, 100);
              }
            }
          } catch(e) {
            console.error('✗ Error authenticating:', e);
            // Fallback: Set token in hash and reload
            console.log('→ Fallback: Setting token in hash and reloading...');
            window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
            setTimeout(function() {
              window.location.reload();
            }, 100);
          }
        } else if (token) {
          // Decap CMS not loaded yet, store token and set in hash
          console.log('→ Decap CMS not loaded yet, storing token and setting in hash...');
          sessionStorage.setItem('decap_oauth_token', token);
          sessionStorage.setItem('decap_oauth_provider', provider);
          // Set token in hash immediately - Decap CMS will read it on load
          window.location.hash = '#/access_token=' + encodeURIComponent(token) + '&token_type=bearer';
          console.log('✓ Token set in hash, Decap CMS should read it on initialization');
        }
      }
    });
    
    // Monitor when Decap CMS loads and check for token in hash
    window.addEventListener('load', function() {
      // Check if token is in hash
      const hash = window.location.hash;
      if (hash.includes('access_token')) {
        console.log('✓ Token found in URL hash on page load');
        console.log('Hash:', hash);
        
        // Extract token from hash
        try {
          const hashParams = new URLSearchParams(hash.substring(2)); // Remove #/
          const token = hashParams.get('access_token');
          const tokenType = hashParams.get('token_type');
          
          if (token) {
            console.log('→ Extracted token from hash, length:', token.length);
            console.log('→ Waiting for Decap CMS to initialize...');
            
            // Wait for Decap CMS to fully initialize
            let checkInterval = setInterval(function() {
              if (window.CMS) {
                try {
                  // Try to access the backend
                  const backend = window.CMS.getBackend();
                  if (backend) {
                    console.log('✓ Decap CMS backend found');
                    clearInterval(checkInterval);
                    
                    // Try to manually authenticate
                    console.log('→ Attempting to authenticate with token from hash...');
                    
                    // Method 1: Try to set token in backend
                    if (backend.implementation && backend.implementation.authenticate) {
                      backend.implementation.authenticate({
                        token: token,
                        token_type: tokenType || 'bearer'
                      }).then(function() {
                        console.log('✓ Authentication successful via backend.implementation.authenticate()');
                        window.location.reload();
                      }).catch(function(err) {
                        console.log('✗ Method 1 failed:', err);
                        // Try method 2
                        tryMethod2();
                      });
                    } else {
                      tryMethod2();
                    }
                    
                    function tryMethod2() {
                      // Method 2: Try to access the auth module directly
                      if (window.CMS && window.CMS.auth) {
                        console.log('→ Trying window.CMS.auth...');
                        window.CMS.auth.authenticate({
                          token: token,
                          provider: 'github'
                        });
                        setTimeout(function() {
                          window.location.reload();
                        }, 1000);
                      } else {
                        // Method 3: Trigger a hashchange event to make Decap CMS re-read the hash
                        console.log('→ Triggering hashchange event...');
                        window.dispatchEvent(new HashChangeEvent('hashchange', {
                          oldURL: window.location.href,
                          newURL: window.location.href
                        }));
                        setTimeout(function() {
                          if (document.querySelector('button[class*="login"]')) {
                            console.log('⚠️ Still showing login - token may not be in correct format');
                            console.log('→ Current hash format:', hash);
                            console.log('→ Decap CMS with auth_endpoint may require token from endpoint, not hash');
                          }
                        }, 2000);
                      }
                    }
                  } else {
                    console.log('→ Backend not available yet, waiting...');
                  }
                } catch(e) {
                  console.log('→ Error accessing backend:', e.message);
                }
              }
            }, 500);
            
            // Stop checking after 10 seconds
            setTimeout(function() {
              clearInterval(checkInterval);
            }, 10000);
          }
        } catch(e) {
          console.error('Error parsing hash:', e);
        }
      } else {
        console.log('→ No token in hash on page load');
      }
      
      // Also check Decap CMS config
      setTimeout(function() {
        if (window.CMS) {
          console.log('✓ Decap CMS loaded successfully');
          try {
            const config = window.CMS.getConfig();
            if (config && config.backend) {
              console.log('Backend:', config.backend.name);
              console.log('Auth endpoint:', config.backend.auth_endpoint || 'not set');
              if (config.backend.auth_endpoint) {
                console.log('✓ Using auth_endpoint - OAuth proxy mode');
                console.log('⚠️ Note: With auth_endpoint, Decap CMS expects token from endpoint response, not hash');
              } else {
                console.log('⚠️ No auth_endpoint - may use direct OAuth');
              }
            }
          } catch(e) {
            console.log('Could not access Decap CMS config:', e.message);
            console.log('→ This may be normal - Decap CMS API may not be fully initialized yet');
          }
        } else {
          console.log('⚠️ Decap CMS not found');
        }
      }, 2000);
    });
    
    // Monitor authentication state changes
    let authCheckInterval = setInterval(function() {
      const loginButton = document.querySelector('button[class*="login"], a[class*="login"]');
      const cmsContent = document.querySelector('[class*="nc-root"], [class*="cms"]');
      
      if (loginButton && loginButton.offsetParent !== null) {
        console.log('→ Showing login screen');
      } else if (cmsContent) {
        console.log('✓ Decap CMS dashboard loaded - authentication successful!');
        clearInterval(authCheckInterval);
      }
    }, 2000);
    
    // Stop checking after 30 seconds
    setTimeout(function() {
      clearInterval(authCheckInterval);
    }, 30000);
  </script>
</head>
<body>
  <div id="nc-root"></div>
  <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
</body>
</html>
