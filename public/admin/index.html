<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // CRITICAL: Prevent Decap CMS from adding #/ to hash
    // Intercept and fix hash changes in real-time
    (function() {
      // Store original hashchange handler
      let originalHash = window.location.hash;
      
      // Function to fix hash format - removes / after # if it's just #/ or #/access_token
      function fixHashFormat() {
        const currentHash = window.location.hash;
        
        // If hash is just #/ (Decap CMS default), remove it
        if (currentHash === '#/' || currentHash === '#') {
          window.history.replaceState(null, null, window.location.pathname);
          return;
        }
        
        // If hash starts with #/access_token, fix it to #access_token
        if (currentHash.startsWith('#/access_token=')) {
          const fixedHash = currentHash.substring(2); // Remove #/
          window.history.replaceState(null, null, '#' + fixedHash);
          return;
        }
        
        // If hash is #/something (but not access_token), preserve it for Decap CMS routing
        // Only fix access_token format
      }
      
      // Intercept hash changes BEFORE Decap CMS processes them
      let hashCheckInterval = setInterval(function() {
        const currentHash = window.location.hash;
        
        // If Decap CMS added #/ and there's no access_token, remove it
        if (currentHash === '#/' && !originalHash.includes('access_token=')) {
          window.history.replaceState(null, null, window.location.pathname);
        }
        
        // If hash has #/access_token, fix it immediately
        if (currentHash.startsWith('#/access_token=')) {
          fixHashFormat();
        }
      }, 50); // Check every 50ms
      
      // Also listen for hashchange events
      window.addEventListener('hashchange', function() {
        fixHashFormat();
      }, true); // Use capture phase to intercept before Decap CMS
      
      // Fix hash on initial load
      if (window.location.hash === '#/') {
        window.history.replaceState(null, null, window.location.pathname);
      }
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          
          // Set token in hash with CORRECT format: #access_token=... (NO /)
          window.location.hash = 'access_token=' + encodeURIComponent(token) + '&token_type=bearer';
          
          // Monitor and fix if Decap CMS tries to change it
          setTimeout(function() {
            if (window.location.hash.startsWith('#/access_token=')) {
              fixHashFormat();
            }
          }, 100);
        }
      });
      
      // Stop monitoring after 10 seconds (Decap CMS should be initialized by then)
      setTimeout(function() {
        clearInterval(hashCheckInterval);
      }, 10000);
    })();
  </script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
