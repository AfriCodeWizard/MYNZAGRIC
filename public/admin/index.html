<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
  <script>
    // Minimal logging to verify OAuth flow with auth_endpoint
    console.log('=== Decap CMS Loading ===');
    console.log('Current URL:', window.location.href);
    console.log('Hash:', window.location.hash);
    
    // Listen for token from OAuth popup (when using auth_endpoint)
    window.addEventListener('message', function(event) {
      // Only accept messages from same origin
      if (event.origin !== window.location.origin) {
        return;
      }
      
      console.log('=== Message received from popup ===');
      console.log('Data:', event.data);
      
      // Check for token in message (from OAuth callback popup)
      if (event.data && (event.data.token || event.data.type === 'authorization')) {
        const token = event.data.token;
        const provider = event.data.provider || 'github';
        
        console.log('✓ Token received from OAuth popup!');
        console.log('Token length:', token ? token.length : 'missing');
        console.log('Provider:', provider);
        
        // Decap CMS should handle this automatically, but log for debugging
        console.log('→ Decap CMS should process this token automatically');
      }
    });
    
    // Monitor when Decap CMS loads
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (window.CMS) {
          console.log('✓ Decap CMS loaded successfully');
          try {
            const config = window.CMS.getConfig();
            if (config && config.backend) {
              console.log('Backend:', config.backend.name);
              console.log('Auth endpoint:', config.backend.auth_endpoint || 'not set');
              if (config.backend.auth_endpoint) {
                console.log('✓ Using auth_endpoint - OAuth proxy mode');
              } else {
                console.log('⚠️ No auth_endpoint - may use direct OAuth');
              }
            }
          } catch(e) {
            console.log('Could not access Decap CMS config');
          }
        } else {
          console.log('⚠️ Decap CMS not found');
        }
      }, 1000);
    });
    
    // Monitor authentication state changes
    let authCheckInterval = setInterval(function() {
      const loginButton = document.querySelector('button[class*="login"], a[class*="login"]');
      const cmsContent = document.querySelector('[class*="nc-root"], [class*="cms"]');
      
      if (loginButton && loginButton.offsetParent !== null) {
        console.log('→ Showing login screen');
      } else if (cmsContent) {
        console.log('✓ Decap CMS dashboard loaded - authentication successful!');
        clearInterval(authCheckInterval);
      }
    }, 2000);
    
    // Stop checking after 30 seconds
    setTimeout(function() {
      clearInterval(authCheckInterval);
    }, 30000);
  </script>
</head>
<body>
  <div id="nc-root"></div>
  <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
</body>
</html>
