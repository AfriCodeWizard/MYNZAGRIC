<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // Handle OAuth token - Decap CMS router adds #/ so token becomes #/access_token=...
    (function() {
      // Function to extract token from hash (handles #/access_token format)
      function getTokenFromHash() {
        const hash = window.location.hash;
        if (!hash || !hash.includes('access_token=')) {
          return null;
        }
        
        // Handle both #/access_token=... and #access_token=...
        // Decap CMS router adds / after #, so token becomes #/access_token=...
        const hashStr = hash.substring(1); // Remove #
        const params = new URLSearchParams(hashStr.replace(/^\/+/, '')); // Remove leading /
        return params.get('access_token');
      }
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          
          // Put token in hash - Decap CMS router will add /, making it #/access_token=...
          // That's OK, we can read it from that format
          window.location.hash = 'access_token=' + encodeURIComponent(token) + '&token_type=bearer';
          
          // Reload to let Decap CMS read the token
          setTimeout(function() {
            window.location.reload();
          }, 100);
        }
      });
      
      // After Decap CMS loads, check if token is in hash and help it authenticate
      function checkAndAuthenticate() {
        const token = getTokenFromHash();
        if (!token) {
          return;
        }
        
        // Token is in hash (likely as #/access_token=...)
        // Wait for Decap CMS to initialize
        if (window.CMS && window.CMS.getBackend) {
          try {
            const backend = window.CMS.getBackend();
            if (backend) {
              // Decap CMS should read token from hash automatically
              // But if it doesn't, try to help
              console.log('Token found in hash, Decap CMS should authenticate');
              
              // Try to trigger authentication if backend has the method
              if (backend.restoreUser) {
                backend.restoreUser();
              }
            }
          } catch(e) {
            console.error('Error checking Decap CMS authentication:', e);
          }
        } else {
          // Decap CMS not ready, try again
          setTimeout(checkAndAuthenticate, 200);
        }
      }
      
      // Start checking after page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(checkAndAuthenticate, 1000);
        });
      } else {
        setTimeout(checkAndAuthenticate, 1000);
      }
    })();
  </script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
