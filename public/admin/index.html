<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
</head>
<body>
  <script>
    // Handle OAuth token - Decap CMS should read from hash automatically
    (function() {
      // Function to extract token from hash (handles both #/access_token and #access_token)
      function getTokenFromHash() {
        const hash = window.location.hash;
        if (!hash || !hash.includes('access_token=')) {
          return null;
        }
        
        // Remove # and any leading / - handle both #/access_token and #access_token
        // Decap CMS router adds / after #, so we need to handle that
        const hashStr = hash.substring(1).replace(/^\/+/, '');
        const params = new URLSearchParams(hashStr);
        return params.get('access_token');
      }
      
      // Check if token exists in hash
      const token = getTokenFromHash();
      if (token) {
        // Token is in hash - Decap CMS should read it automatically
        // But if it doesn't, we'll try to help it along
        console.log('Token found in hash, waiting for Decap CMS to authenticate...');
        
        // Store token in case Decap CMS needs it
        sessionStorage.setItem('github_token', token);
        
        // Wait for Decap CMS to load and check if it authenticated
        let checkCount = 0;
        const maxChecks = 50; // Check for 5 seconds
        
        function checkAuthentication() {
          checkCount++;
          
          // Check if Decap CMS is loaded
          if (window.CMS) {
            try {
              const backend = window.CMS.getBackend();
              if (backend) {
                // Check if backend has a token
                if (backend.token) {
                  console.log('Decap CMS authenticated successfully');
                  return;
                }
                
                // If no token after a few seconds, try to set it
                if (checkCount > 10 && !backend.token) {
                  console.log('Attempting to set token manually...');
                  // Try to access the backend's internal auth
                  if (backend.authToken !== token) {
                    backend.authToken = token;
                  }
                }
              }
            } catch(e) {
              // Decap CMS API might not be accessible, that's OK
            }
          }
          
          if (checkCount < maxChecks) {
            setTimeout(checkAuthentication, 100);
          } else {
            console.warn('Decap CMS did not authenticate automatically. Token is in hash:', token.substring(0, 10) + '...');
          }
        }
        
        // Start checking after a short delay to let Decap CMS initialize
        setTimeout(checkAuthentication, 500);
      }
      
      // Listen for postMessage from OAuth popup
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
          return;
        }
        
        const data = event.data;
        if (data && (data.token || data.access_token)) {
          const token = data.token || data.access_token;
          sessionStorage.setItem('github_token', token);
          
          // Put token in hash - Decap CMS will read it
          // Note: Decap CMS router may add / after #, that's fine
          window.location.hash = 'access_token=' + encodeURIComponent(token) + '&token_type=bearer';
          
          // Reload to let Decap CMS read the token
          setTimeout(function() {
            window.location.reload();
          }, 100);
        }
      });
    })();
  </script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
</body>
</html>
